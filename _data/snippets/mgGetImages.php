id: 5
name: mgGetImages
description: 'Get images from a MoreGallery resource. (Part of MoreGallery)'
category: MoreGallery
properties: "a:21:{s:5:\"cache\";a:7:{s:4:\"name\";s:5:\"cache\";s:4:\"desc\";s:34:\"moregallery.mggetimages.cache_desc\";s:4:\"type\";s:13:\"combo-boolean\";s:7:\"options\";s:0:\"\";s:5:\"value\";b:1;s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:8:\"resource\";a:7:{s:4:\"name\";s:8:\"resource\";s:4:\"desc\";s:37:\"moregallery.mggetimages.resource_desc\";s:4:\"type\";s:11:\"numberfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";i:0;s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:6:\"sortBy\";a:7:{s:4:\"name\";s:6:\"sortBy\";s:4:\"desc\";s:35:\"moregallery.mggetimages.sortby_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:9:\"sortorder\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:7:\"sortDir\";a:7:{s:4:\"name\";s:7:\"sortDir\";s:4:\"desc\";s:36:\"moregallery.mggetimages.sortdir_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:3:\"ASC\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:5:\"where\";a:7:{s:4:\"name\";s:5:\"where\";s:4:\"desc\";s:34:\"moregallery.mggetimages.where_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:0:\"\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:4:\"tags\";a:7:{s:4:\"name\";s:4:\"tags\";s:4:\"desc\";s:33:\"moregallery.mggetimages.tags_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:0:\"\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:11:\"tagsFromUrl\";a:7:{s:4:\"name\";s:11:\"tagsFromUrl\";s:4:\"desc\";s:40:\"moregallery.mggetimages.tagsfromurl_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:0:\"\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:7:\"getTags\";a:7:{s:4:\"name\";s:7:\"getTags\";s:4:\"desc\";s:36:\"moregallery.mggetimages.gettags_desc\";s:4:\"type\";s:13:\"combo-boolean\";s:7:\"options\";s:0:\"\";s:5:\"value\";b:1;s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:17:\"getResourceFields\";a:7:{s:4:\"name\";s:17:\"getResourceFields\";s:4:\"desc\";s:46:\"moregallery.mggetimages.getresourcefields_desc\";s:4:\"type\";s:13:\"combo-boolean\";s:7:\"options\";s:0:\"\";s:5:\"value\";b:0;s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:14:\"getResourceTVs\";a:7:{s:4:\"name\";s:14:\"getResourceTVs\";s:4:\"desc\";s:43:\"moregallery.mggetimages.getresourcetvs_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:0:\"\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:6:\"tagTpl\";a:7:{s:4:\"name\";s:6:\"tagTpl\";s:4:\"desc\";s:35:\"moregallery.mggetimages.tagtpl_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:5:\"mgtag\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:8:\"imageTpl\";a:7:{s:4:\"name\";s:8:\"imageTpl\";s:4:\"desc\";s:37:\"moregallery.mggetimages.imagetpl_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:7:\"mgimage\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:14:\"singleImageTpl\";a:7:{s:4:\"name\";s:14:\"singleImageTpl\";s:4:\"desc\";s:43:\"moregallery.mggetimages.singleimagetpl_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:13:\"mgimagesingle\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:12:\"tagSeparator\";a:7:{s:4:\"name\";s:12:\"tagSeparator\";s:4:\"desc\";s:41:\"moregallery.mggetimages.tagseparator_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:1:\"\n\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:14:\"imageSeparator\";a:7:{s:4:\"name\";s:14:\"imageSeparator\";s:4:\"desc\";s:43:\"moregallery.mggetimages.imageseparator_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:1:\"\n\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:10:\"wrapperTpl\";a:7:{s:4:\"name\";s:10:\"wrapperTpl\";s:4:\"desc\";s:39:\"moregallery.mggetimages.wrappertpl_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:0:\"\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:13:\"toPlaceholder\";a:7:{s:4:\"name\";s:13:\"toPlaceholder\";s:4:\"desc\";s:42:\"moregallery.mggetimages.toplaceholder_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:0:\"\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:8:\"totalVar\";a:7:{s:4:\"name\";s:8:\"totalVar\";s:4:\"desc\";s:37:\"moregallery.mggetimages.totalvar_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:5:\"total\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:5:\"limit\";a:7:{s:4:\"name\";s:5:\"limit\";s:4:\"desc\";s:34:\"moregallery.mggetimages.limit_desc\";s:4:\"type\";s:11:\"numberfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";i:0;s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:6:\"offset\";a:7:{s:4:\"name\";s:6:\"offset\";s:4:\"desc\";s:35:\"moregallery.mggetimages.offset_desc\";s:4:\"type\";s:11:\"numberfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";i:0;s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}s:6:\"scheme\";a:7:{s:4:\"name\";s:6:\"scheme\";s:4:\"desc\";s:35:\"moregallery.mggetimages.scheme_desc\";s:4:\"type\";s:9:\"textfield\";s:7:\"options\";s:0:\"\";s:5:\"value\";s:0:\"\";s:7:\"lexicon\";s:19:\"moregallery:default\";s:4:\"area\";s:0:\"\";}}"

-----

/**
 * Gets the photos for the current (or specified) mgResource.
 *
 * @author Mark Hamstra for modmore <support@modmore.com>
 * @var modX $modx
 * @var array $scriptProperties
 */

$scriptProperties = array_merge(array(
    'cache' => true,
    'resource' => $modx->resource->get('id'),
    'activeOnly' => true,
    'sortBy' => 'sortorder',
    'sortDir' => 'ASC',
    'where' => '',

    'tags' => '',
    'tagsFromUrl' => '',
    'getTags' => true,

    'getResourceFields' => false,
    'getResourceTVs' => '',

    'tagTpl' => 'mgtag',
    'imageTpl' => 'mgimage',
    'singleImageTpl' => 'mgimagesingle',
    'tagSeparator' => "\n",
    'imageSeparator' => "\n",
    'wrapperTpl' => '',
    'toPlaceholder' => '',

    'totalVar' => 'total',
    'limit' => 0,
    'offset' => 0,

    'scheme' => $modx->getOption('link_tag_scheme'),
), $scriptProperties);
$scriptProperties['resource'] = $scriptProperties['resource'] > 0 ? $scriptProperties['resource'] : $modx->resource->get('id');

$singleImageUrlParam = $modx->getOption('moregallery.single_image_url_param', null, 'iid');
$random = in_array(strtolower($scriptProperties['sortBy']), array('random', 'rand', 'rand()'));

/** @var moreGallery $moreGallery */
$corePath = $modx->getOption('moregallery.core_path', null, $modx->getOption('core_path') . 'components/moregallery/');
$moreGallery = $modx->getService('moregallery', 'moreGallery', $corePath . 'model/moregallery/');
if (!($moreGallery instanceof moreGallery)) {
    $modx->log(modX::LOG_LEVEL_ERROR, 'Error loading moreGallery class from ' . $corePath);
    return 'Error loading moreGallery class.';
}
$cacheOptions = array(xPDO::OPT_CACHE_KEY => 'moregallery');
$emptyImageArray = $modx->newObject('mgImage')->toArray();
$emptyImageArray['resource'] = $modx->newObject('modResource', array('id' => $modx->getOption('site_start')))->toArray();

if (isset($_GET[$singleImageUrlParam]) && is_numeric($_GET[$singleImageUrlParam])) {
    $cacheKey = 'mgimage/' . $scriptProperties['resource'] . '/' . $_GET[$singleImageUrlParam] . '.' . $scriptProperties['sortBy'] . '.' . strtolower($scriptProperties['sortDir']);
    $cached = $modx->cacheManager->get($cacheKey, $cacheOptions);
    if ($scriptProperties['cache'] && is_array($cached)) {
        $formatted = $moreGallery->getChunk($scriptProperties['singleImageTpl'], $cached);
        if (!empty($scriptProperties['toPlaceholder'])) {
            $modx->setPlaceholder($scriptProperties['toPlaceholder'], $formatted);
            return '';
        } else {
            return $formatted;
        }
    }

    $image = $modx->getObject('mgImage', array(
        'resource' => $scriptProperties['resource'],
        'id' => (int)$_GET[$singleImageUrlParam],
    ));
    if ($image instanceof mgImage) {
        if ($scriptProperties['activeOnly'] && !$image->get('active'))
        {
            $modx->sendErrorPage();
        }
        
        $phs = $image->toArray();
        if (is_numeric($phs['url']) && $phs['url'] > 0) {
            $phs['url'] = $modx->makeUrl($phs['url'], '', '', $scriptProperties['scheme']);
        }

        /**
         * If desired, get data from resources. This is useful when using within a getResources template
         * for example, where because of calling mgGetImages uncached the resource data is not available
         * in the image template.
         */
        $resource = null;
        if ($scriptProperties['getResourceFields'] || !empty($scriptProperties['getResourceTVs'])) {
            $resource = ($modx->resource->get('id') == $scriptProperties['resource']) ? $modx->resource : $modx->getObject('modResource', $scriptProperties['resource']);
        }

        if ($resource && $scriptProperties['getResourceFields']) {
            $phs = array_merge($phs, $resource->toArray('resource.'));
        }
        if ($resource && !empty($scriptProperties['getResourceTVs'])) {
            $tvs = explode(',', $scriptProperties['getResourceTVs']);
            foreach ($tvs as $key) {
                $phs['resource.' . $key] = $resource->getTVValue($key);
            }
        }

        $phs['crops'] = $image->getCropsAsArray();

        /**
         * Get previous and next images.
         */
        $prev = $image->getPrevious($scriptProperties['sortBy'], $scriptProperties['activeOnly']);
        if ($prev instanceof mgImage) {
            $phs['prev'] = $prev->toArray();
            if (is_numeric($phs['prev']['url']) && $phs['prev']['url'] > 0) {
                $phs['prev']['url'] = $modx->makeUrl($phs['prev']['url'], '', '', $scriptProperties['scheme']);
            }
            $phs['prev']['crops'] = $prev->getCropsAsArray();
        }

        $next = $image->getNext($scriptProperties['sortBy'], $scriptProperties['activeOnly']);
        if ($next instanceof mgImage) {
            $phs['next'] = $next->toArray();
            if (is_numeric($phs['next']['url']) && $phs['next']['url'] > 0) {
                $phs['next']['url'] = $modx->makeUrl($phs['next']['url'], '', '', $scriptProperties['scheme']);
            }
            $phs['next']['crops'] = $next->getCropsAsArray();
        }

        // If the sortorder is DESC, swap previous and next to maintain the right order.
        if (strtoupper($scriptProperties['sortDir']) == 'DESC') {
            $prev = isset($phs['prev']) ? $phs['prev'] : null;
            $phs['prev'] = isset($phs['next']) ? $phs['next'] : null;
            $phs['next'] = $prev;
        }

        if ($scriptProperties['getTags']) {
            $phs['tags_raw'] = $image->getTags();
            $phs['tags'] = array();

            foreach ($phs['tags_raw'] as $tag) {
                $phs['tags'][] = $moreGallery->getChunk($scriptProperties['tagTpl'], $tag);
            }
            $phs['tags'] = implode($scriptProperties['tagSeparator'], $phs['tags']);
        }

        $modx->cacheManager->set($cacheKey, $phs, 0, $cacheOptions);

        $formatted = $moreGallery->getChunk($scriptProperties['singleImageTpl'], $phs);
        if (!empty($scriptProperties['toPlaceholder'])) {
            $modx->setPlaceholder($scriptProperties['toPlaceholder'], $formatted);
            return '';
        } else {
            return $formatted;
        }
    }
    $modx->sendErrorPage();
    return;
}

// Process for tags
$tags = $scriptProperties['tags'];
if (!empty($scriptProperties['tagsFromUrl']) && isset($_GET[$scriptProperties['tagsFromUrl']])) {
    $tags = $_GET[$scriptProperties['tagsFromUrl']];
    $tags = $modx->sanitizeString($tags);
}
if (!empty($tags)) {
    $scriptProperties['tags'] = explode(',', $tags);
}
else {
    $scriptProperties['tags'] = null;
}

// Make a copy of $scriptProperties and unset the cache property so we can write to the
// same cache key whether cache is enabled or disabled.
$props = $scriptProperties;
unset($props['cache']);
$cacheKey = 'mgimages/' . $scriptProperties['resource'] . '/' . md5(serialize($props));
$chunkHash = md5($moreGallery->getChunk($scriptProperties['imageTpl'], $emptyImageArray)) . md5($moreGallery->getChunk($scriptProperties['wrapperTpl'], array('output' => '')));
if ($scriptProperties['getTags']) {
    $chunkHash .= md5($moreGallery->getChunk($scriptProperties['tagTpl']));
}

if ($scriptProperties['cache']) {
    // If we can use cache, see if it's available for us.
    $cached = $modx->cacheManager->get($cacheKey, $cacheOptions);
    if (is_array($cached)) {
        if ($random && !empty($cached['objects'])) {
            // Wiggle wiggle wiggle yeah
            shuffle($cached['objects']);
            // Grab the number of objects we want
            if ($scriptProperties['limit'] > 0) {
                $cached['objects'] = array_slice($cached['objects'], 0, $scriptProperties['limit']);
            }

            // Format it
            $formatted = array();
            foreach ($cached['objects'] as $object) {
                $formatted[] = $moreGallery->getChunk($scriptProperties['imageTpl'], $object);
            }
            $formatted = implode($scriptProperties['imageSeparator'], $formatted);

            if (!empty($scriptProperties['wrapperTpl'])) {
                $formatted = $moreGallery->getChunk($scriptProperties['wrapperTpl'], array('output' => $formatted, 'image_count' => $total));
            }

            // return it
            if (!empty($scriptProperties['toPlaceholder'])) {
                $modx->setPlaceholder($scriptProperties['toPlaceholder'], $formatted);
                return '';
            } else {
                return $formatted;
            }
        }

        elseif ($chunkHash == $cached['chunkHash']) {
            $modx->setPlaceholder($modx->getOption('totalVar', $scriptProperties, 'total'), $cached['total']);

            $formatted = $cached['formatted'];
            if (!empty($scriptProperties['toPlaceholder'])) {
                $modx->setPlaceholder($scriptProperties['toPlaceholder'], $formatted);
                return '';
            } else {
                return $formatted;
            }
        }
    }
}

// Get the images
$c = $modx->newQuery('mgImage');
$c->where(array(
    'resource' => $scriptProperties['resource'],
));
if ($scriptProperties['activeOnly'])
{
    $c->where(array('active' => true));
}

if (!empty($scriptProperties['where']))
{
    $where = $modx->fromJSON($scriptProperties['where']);
    if (is_array($where))
    {
        $c->where($where);
    }
    else
    {
        $modx->log(modX::LOG_LEVEL_ERROR, '&where property is not valid JSON: ' . $scriptProperties['where'], '', 'mgGetImages', __FILE__, __LINE__);
    }
}

// Filter on Tags
// Added in 1.1
if (is_array($scriptProperties['tags'])) {
    $allTagIds = $moreGallery->getTagIds();
    $tagIds = array();
    foreach ($scriptProperties['tags'] as $tag) {
        if (is_numeric($tag)) $tagIds[] =  (int)$tag;
        else {
            $search = array_search($tag, $allTagIds);
            if (is_numeric($search) && $search > 0) $tagIds[] = $search;
        }
    }

    if (empty($tagIds)) $tagIds[] = 0;

    $c->rightJoin('mgImageTag', 'Tags');
    $c->where(array(
        'Tags.tag:IN' => $tagIds
    ));
}

// Get total + set placeholder to enable getPage-based pagination.
// https://www.markhamstra.com/modx-blog/2011/12/preparing-custom-snippets-for-getpage/
$total = $modx->getCount('mgImage', $c);
$modx->setPlaceholder($modx->getOption('totalVar', $scriptProperties, 'total'), $total);
if (!$random && $scriptProperties['limit'] > 0) {
    $c->limit($scriptProperties['limit'], $scriptProperties['offset']);
}

// Apply sorting if this isn't a random sort
if (!$random) {
    $c->sortby($scriptProperties['sortBy'], $scriptProperties['sortDir']);
}
else {
    $c->sortby('RAND()');
}

/**
 * If desired, get data from resources. This is useful when using within a getResources template
 * for example, where because of calling mgGetImages uncached the resource data is not available
 * in the image template.
 */
$resource = null;
$resourceData = array();
if ($scriptProperties['getResourceFields'] || !empty($scriptProperties['getResourceTVs'])) {
    $resource = ($modx->resource->get('id') == $scriptProperties['resource']) ? $modx->resource : $modx->getObject('modResource', $scriptProperties['resource']);
}

if ($resource && $scriptProperties['getResourceFields']) {
    $resourceData = $resource->toArray('resource.');
}
if ($resource && !empty($scriptProperties['getResourceTVs'])) {
    $tvs = explode(',', $scriptProperties['getResourceTVs']);
    foreach ($tvs as $key) {
        $resourceData['resource.' . $key] = $resource->getTVValue($key);
    }
}

$data = array();
$i = 0;
$iterator = $modx->getIterator('mgImage', $c);
foreach ($iterator as $image) {
    /** @var mgImage $image */
    $imageArr = array_merge($resourceData, $image->toArray());
    $imageArr['idx'] = $i;
    if (is_numeric($imageArr['url']) && $imageArr['url'] > 0) {
        $imageArr['url'] = $modx->makeUrl($imageArr['url'], '', '', $scriptProperties['scheme']);
    }


    if ($scriptProperties['getTags']) {
        $imageArr['tags_raw'] = $image->getTags();
        $imageArr['tags'] = array();

        foreach ($imageArr['tags_raw'] as $tag) {
            $imageArr['tags'][] = $moreGallery->getChunk($scriptProperties['tagTpl'], $tag);
        }
        $imageArr['tags'] = implode($scriptProperties['tagSeparator'], $imageArr['tags']);
    }

    $imageArr['crops'] = $image->getCropsAsArray();

    $data[$i] = $imageArr;
    if (isset($data[$i - 1])) {
        $data[$i]['prev'] = $data[$i - 1];
        $data[$i - 1]['next'] = $imageArr;
        // Prevent some sort of recursive array
        unset($data[$i]['prev']['prev']);
    }
    $i++;
}
$rawData = $data;

if ($random && $scriptProperties['limit'] > 0) {
    $data = array_splice($data, 0, $scriptProperties['limit']);
}

$formatted = array();
foreach ($data as $phs) {
    $formatted[] = $moreGallery->getChunk($scriptProperties['imageTpl'], $phs);
}
$formatted = implode($scriptProperties['imageSeparator'], $formatted);

if (!empty($scriptProperties['wrapperTpl'])) {
    $formatted = $moreGallery->getChunk($scriptProperties['wrapperTpl'], array('output' => $formatted, 'image_count' => $total));
}

$cached = array(
    'total' => $total,
    'formatted' => $formatted,
    'chunkHash' => $chunkHash,
    'cached' => date('c'),
);
if ($random) {
    $cached['objects'] = $rawData;
    unset($cached['formatted']);
}
// Write to cache (even if we don't use it, cause we may use it later)
$modx->cacheManager->set($cacheKey, $cached, 0, $cacheOptions);

if (!empty($scriptProperties['toPlaceholder'])) {
    $modx->setPlaceholder($scriptProperties['toPlaceholder'], $formatted);
} else {
    return $formatted;
}